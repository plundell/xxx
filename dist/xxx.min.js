!function(t){var e={};function i(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){
/*
* @module xxx-framework
* @author plundell
* @license Apache-2.0
* @depends libbetter
* @depends smarties
* @exports function   This framework exports an "exporter function" which should be called with the 
*                     dependencies to get the "real exported contents". It also creates a getter on
*                     window.xxx which runs said exporter if the dependencies are also set on the window
*/
!function(){if(!window)throw new Error("ESCOPE. This script should have access to the 'window' global.");console.log("Loading xxx-framework...");const t=i(1);Object.defineProperty(window,"xxx",{enumerable:!0,configurable:!0,get:()=>{if(window.Smarties&&window.BetterLog&&window.BetterEvents&&window.BetterUtil)return window.xxx=t(window);throw new Error("E_DEPENDENCY. The xxx-framework could not be initialized because it's dependencies have not been set on the global scope")},set:t=>(Object.defineProperty(window,"xxx",{value:t,enumerable:!0,writable:!0,configurable:!0}),t)})}()},function(t,e,i){
/*
* @component Prototype
* @part-of xxx-framework
* @author plundell
* @license Apache-2.0
* @description This is the main file of the frontend xxx-framework. It requires the other components and produces an
*              object containing their constructors: Binder, Navigator, Repeater.
* @depends libbetter
* @depends smarties
* @exports function   This framework exports an "exporter function" which should be called with the 
*                     dependencies to get the "real exported contents". 
*/
t.exports=function(t){function e(t){throw new Error("xxx-framework was initialized without/before a required dependency: "+t)}t.BetterUtil||e("BetterUtil"),t.BetterLog||e("BetterLog"),t.BetterEvents||e("BetterEvents"),t.Smarties||e("Smarties");const r=t.BetterUtil;var n={},a=new t.BetterLog("xxx-framework");function s(...t){t.find(t=>{if(t){if(t._isBetterLog)return t;if(t.log&&t.log._isBetterLog)return t.log;if(t._log&&t._log._isBetterLog)return t._log}});return a}try{let t=r.createCSSRule(".xxx-hide","display:none !important");a.info("Created CSS rule for class 'xxx-hide', used by the xxx framework to hide elements.",t)}catch(t){a.error("Failed to create css rule to hide elements. Hiding elements with this framework WILL NOT WORK NOW.",t)}function o(t){try{var e={};t.forEach(t=>{Array.isArray(t.key)?t.key.forEach(i=>r.pushToNestedArray(e,i,t)):r.pushToNestedArray(e,t.key,t)}),Object.defineProperty(e,"keys",{value:function(){return Object.keys(e)}}),Object.defineProperty(e,"values",{value:function(){return t}}),Object.defineProperty(e,"length",{get:()=>t.length})}catch(t){s(this).error("BUGBUG",t).addHandling("arguments:",arguments)}return e}function l(t,e){var i=m.call(this,e);i.test==t?(this._log.trace("Showing node:",e.node,i.logstr),c(e.node)):(this._log.trace("Hiding node:",e.node,i.logstr),h(e.node))}function h(t){(t=r.getLiveElement(t)).classList.add("xxx-hide"),r.hideElement(t)}function c(t){(t=r.getLiveElement(t)).classList.remove("xxx-hide"),r.showElement(t)}function u(t){var e="BUGBUG: followClass() was called with the string 'undefined', probably a mistake.",i="";if(t.old&&"string"==typeof t.old){if("undefined"==t.old)return void this._log.warn(e,arguments);i+=`Removing class '${t.old}'`,t.node.classList.remove(t.old)}if("string"==typeof t.value){if("undefined"==t.value)return void this._log.warn(e,arguments);i+=(i?" and a":"A")+`dding class '${t.value}'`,t.node.classList.add(t.value)}i?this._log.trace(i,t.node):this._log.warn("Something went wrong. Class has probably NOT been updated. \narguments:",arguments),t.node.classList&&!t.node.classList.length&&t.node.removeAttribute("class")}function p(t){let e=t.cls||t.args[0];r.checkType("string",e),"undefined"==e&&this._log.throw("toggleClass() was called with the string 'undefined', probably a mistake.",t),m.call(this,t).test?t.node.classList.contains(e)?this._log.trace(`Node already has class '${e}'.`,t.node):(this._log.trace(`Adding class '${e}' to node:`,t.node),t.node.classList.add(e)):t.node.classList.contains(e)?(this._log.trace(`Removing class '${e}' from node:`,t.node),t.node.classList.remove(e)):this._log.trace(`Node correctly doesn't have class '${e}'.`,t.node)}function d(t){let e=t.prop||t.args[0];r.checkType("string",e),this._log.trace(`Setting prop '${e}' = ${t.value}`,t.node),t.node[e]=t.value}function g(t){let e=t.args[0],i=t.args.length>1?t.args[1]:t.value,r=t.args[2],n=m.call(this,t),a=n.test?i:r;this._log.trace(`Setting prop '${e}' = ${a}`,t.node,n.logstr),t.node[e]=a}function f(t){r.checkTypes(["string",["string","undefined"]],t.args);let e=t.args[0],i=2==t.args.length?t.args[1]:t.value,n=m.call(this,t);n.test?(this._log.trace(`Setting attr '${e}'='${i}' on node:`,t.node,n.logstr),t.node.setAttribute(e,i)):(this._log.trace(`Removing attr '${e}' from node:`,t.node,n.logstr),t.node.removeAttribute(e))}function y(t){var e=t.format||t.args[0];if(e)if("function"==typeof e)t.value=e(t.value);else if("string"==typeof e){let i=r.formatString(e,t.value);if(i)t.value=i;else try{let i=e.split(".");e=r.nestedGet(this||window,i)||r.nestedGet(window,i),t.value=e(t.value)}catch(t){s(this).warn("Bad 'format' arg",e)}}else s(this).makeTypeError("'format' arg to be function or string",e).changeLvl("warn").exec();r.setFirstTextNode(t.node,t.value)}function v(t,e,i=!1){r.checkTypes(["string","function"],[t,e]),t=t.toLowerCase();var n=this._private.actions;n.hasOwnProperty(t)?(n[t].push(e),i||this._log.debug(`Chained function to action '${t}'. Total funcs: ${n[t].length}`)):(n[t]=[e],i||this._log.debug(`Registered action '${t}'.`))}function _(t){var e={test:r.compare(t.value,t.test[0],t.test[1],t.test[2])};return this._log.options.lowestLvl<3&&(e.logstr=(e.test?"<not> ":"")+r.logVar(t.value)+t.test[0]+r.logVar(t.test[1])+(null==t.test[2]?"":" "+String(t.test[2]))),e}function m(t){if(t&&t.test&&t.test.hasOwnProperty("test"))return t.test;var e={test:!r.isEmpty(t.value,"*")};return this._log.options.lowestLvl<3&&(e.logstr=r.logVar(t.value),e.logstr=(e.test?"<not empty> ":"<empty> ")+e.logstr),e}function b(e,i,r,n){var a=s(this);if("$"==r)return a.trace("Pattern '$', using original value:",i,n),i;if("#"==r)return a.trace("Pattern '#', using key only:",e,n),e;t.bu.checkType("string",r);let o=null==i?"empty":"object"==typeof i?"":"throw";var l=r.split(/(\$\{[^}]+\}|#|\$)/).filter(t=>t).map(n=>{if("$"==n)return i;if("#"==n)return e;let s=n.match(/\$\{([^}]+)\}/);if(s){if("empty"==o)return"";"throw"==o&&a.makeError("Got complex pattern but primitive value.",{pattern:r,part:n,value:i}).setCode("EMISSMATCH").throw();let e=s[1].contains(".")?t.bu.nestedGet(i,s[1].split(".")):i[s[1]];return"undefined"==e||null==e?"":e}return n}).join(""),h=t.bu.stringToPrimitive(l);return""===h&&"noWarn"!=arguments[3]?a.warn("Resolved pattern to empty string:",{pattern:r,value:i,key:e},n):a.trace(`Resolved pattern '${r}':`,[i,"=>",h],n),h}var w={prototype:{registerActionHandler:v,executeAction:function(t,e,i){try{if(!this._private.actions.hasOwnProperty(e.fn))throw`No handler for action '${String(e.fn)}'`;var r=Object.assign({},e,{node:t},i);r.pattern&&(r.value=b.call(this,r.key,r.value,r.pattern),null!=r.old&&(r.old=b.call(this,r.key,r.old,r.pattern))),r.test&&(r.test=_.call(this,r));var n=this._private.actions[e.fn],a=`Executing fn '${e.fn}'`;n.length>1?(this._log.debug(`${a} (${n.length} funcs):`,{funcs:n.map(t=>t.name),arg:r}),n.forEach(t=>t.call(this,r))):(this._log.trace(a+":",r),n[0].call(this,r))}catch(i){"abort"===i?this._log.trace(`Aborted '${e.fn}'`):this._log.error("Failed to execute action.",i,t,e)}}},static:{hideElement:h,showElement:c,setText:y,applyPattern:b},getInstructions:function(t,...e){r.checkType("node",t);const i=s(this);try{var n=[],a=this.constructor._baseAttr,l=r.getFirstOfType(e,"function"),h=e.includes("extract"),c=e.includes("group"),u=e.includes("emptyOK"),p=t=>{t.key=t.key||g;let e=r.checkProps(t,{fn:"string",key:["number","string","array"],args:["array","primitive","undefined"],arg:["primitive","undefined"],test:["array","primitive","undefined"]});if(t.fn,t.fn.toLowerCase(),"primitive"==e.args?t.args=[t.args]:"undefined"==e.args&&("primitive"==e.arg?t.args=[t.arg]:t.args=[]),"undefined"!=e.test){if("primitive"==e.test)t.test=r.compare.splitOnOperator(t.test);else if("array"==e.test)if(1==t.test.length)t.test=r.compare.splitOnOperator(t.test[0]);else{let i=t.test.findIndex(r.compare.isOperator);if(-1==i)throw new Error("No compare operator found");0!=i&&t.test.unshift(e.test.splice(i,1))}t.test[0]||(t.test[0]="===")}l&&"drop"==l(t)||n.push(t)},d=(t,e,r,n)=>{r.setAttribute(e+"_fail",t),r.removeAttribute(e),i.error(`Bad ${e} instructions on node:`,r,n)},g=r.tryJsonParse(t.getAttribute(a+"_key")),f=t.getAttribute(a);if(f)try{let e=JSON.parse(f);"object"==r.checkType(["array","object"],e)?p(e):e.forEach(p),h&&t.removeAttribute(a)}catch(e){d(f,a,t,e)}var y=r.getSubAttributes(t,a+"-",h);for(let e in y)try{if(e.includes("_fail"))continue;let t=r.tryJsonParse(y[e]);if("object"==r.varType(t))t.fn=e,p(t);else{let i=r._log.last();i&&i.msg.includes("poorly formated JSON string")?i.throw():p(g?{args:t,fn:e}:{key:t,fn:e})}}catch(i){d(y[e],a+"-"+e,t,i)}r.isEmpty(n)?u||t.hasAttribute(a+"_noaction")||i.warn(`Node doesn't have ${a} instructions: `,t):i.debug(`Found ${a} instructions on node: `,t,n)}catch(t){i.error("BUGBUG",t).addHandling("arguments:",arguments)}return c&&(n=o(n)),n},setupActions:function(t){if(this._private.actions={},Array.isArray(t))if("!"==t[0])var e=t.slice(1);else var i=t;var n=(t,r)=>{i&&-1==i.indexOf(t)||e&&e.indexOf(t)>=-1||v.call(this,t,r,!0)};n("hide",l.bind(this,!1)),n("show",l.bind(this,!0)),n("id",t=>t.node.id=t.value),n("class",u.bind(this)),n("classif",p.bind(this)),n("prop",d.bind(this)),n("propif",g.bind(this)),n("attr",f.bind(this)),n("value",t=>{r.setValueOnElem(t.node,t.value)}),n("html",t=>{t.node.innerHTML=t.value}),n("text",y.bind(this)),n("showtext",t=>{y(t),l.call(this,!0,t)}),n("onclick",t=>{if("function"==typeof t.value)t.node.onclick=t.value;else{let e=t.value.split("."),i=1==e.length?this[t.value]:r.nestedGet(this,e);i&&"function"==typeof i?t.node.onclick=i:t.node.setAttribute("onclick",t.value)}})},addInstance:function(t){const e=s(this);try{if(r.checkType("string",t),"undefined"==t)throw"The string 'undefined' is not suitable as targetClass"}catch(t){e.throw(`Bad targetClass (arg#1), cannot setup xxx.${this.constructor.name}.`,t)}var i;for(i in n){let r=n[i];r.hasOwnProperty("_instances")&&r._instances.has(t)&&e.makeError(`A xxx.${r.name} with class ${t} already exists`,r._instances.get(t)).setCode("EEXIST").throw()}this.constructor._instances.set(t,this)},setupPrivateLogEvents:function(e,i){r.checkType("object",i),Object.defineProperty(this,"_private",{enumerable:!1,value:{targetClass:e}}),this._private.options=Object.assign({},this.constructor._defaultOptions,i),Object.defineProperty(this,"_log",{enumerable:!1,value:new t.BetterLog(this,Object.assign({name:e},i))}),t.BetterEvents.call(this),Object.defineProperty(this._betterEvents,"onerror",{value:this._log.error})},getLog:s};return n.Binder=w.Binder=i(2)(t,w),n.Navigator=i(3)(t,w),n.Repeater=i(4)(t,w),n}},function(t,e,i){"use strict";
/*
* @component Binder
* @part-of xxx-framework
* @description This component provides two-way databinding to the DOM. 
* @author plundell
* @license Apache-2.0
* @note: This component is required by ./xxx.proto.js, you should not need to access it directly.
* @depends libbetter
* @depends ./xxx.proto.js
* @depends smarties.Object
* @exports {function} Call this function with the dependencies to get the Binder constructor
*
* Details:
*	- <Binder> objects extend <SmartObject>, ie. 1 binder per 1 smarty. Alternatively the binder can create
*	  an empty smarty and replicate its events.
*	- Outputting to the DOM is done by listening to events on the underlying smarty
*	- Inputting from the DOM is done by listening to 'input' events on <body> (ie. you can affect how/when
*	  the binder receives input by intercepting these events before they reach <body>, which is exactly
*	  what Binder.throttle() does). 
*/t.exports=function(t,e){const i=t.BetterUtil,r="xxxBindInstructions",n="xxxBinder",a="xxxBind_valInst",s="xxxBind_key";function o(r,n=null,a=null){e.addInstance.call(this,r),(n=n||{}).name=r,this===a?(this._log.info("Turning this smarty into a Binder"),this.__proto__=o.prototype,n=i.subObj(n,["scrapeForData","ignoreTimeout","name"],"excludeMissing"),Object.assign(this._private.options,n),this._log.changeName(n.name)):(a&&"object"==typeof a&&("SmartObject"==a.isSmart&&(this.replicateFrom(a),a=a.stupify()),n.defaultValues=Object.assign({},n.defaultValues,a)),t.Smarties.Object.call(this,Object.assign({},o._defaultOptions,n))),this._private.targetClass=r,e.setupActions.call(this),this.on("event",g.bind(this)),this.getOutputs().length&&this.length&&this.setup()}function l(t){let e=c.call(this,t);return e&&(u.call(this,t),p.call(this,t)),e}function h(t){delete t[n],delete t[r],delete t[s],delete t[a]}function c(t){if(!t.hasOwnProperty(n)){let e=Array.from(t.classList).find(t=>o._instances.has(t));e&&(t[n]=o._instances.get(e))}return t[n]}function u(t,i){return t.hasOwnProperty(r)||(t[r]=e.getInstructions.call(this,t,"group"),delete t[s],delete t[a]),"string"==typeof i?(t[r][i]||[]).concat(t[r]["*"]||[]):t[r]}function p(t){try{if(!t.hasOwnProperty(s)){var e,r,n=null,o=u.call(this,t);t:for(e in o){for(r of o[e]){if("value"==r.fn)break t;"text"!=r.fn&&"html"!=r.fn||(n=e)}e=void 0}t[a]=r,t[s]=e||n}return t[s]}catch(e){(this._log||i._log).makeError("Failed to identify key bound to value",t,o,e).throw()}}function d(t){if(t.target[n]&&!t.target.hasAttribute("xxx-bind_ignore")){let e=t.target[n],i=p.call(e,t.target);if(null==i)return void e._log.warn("Couldn't find a key on input bound to this Binder.",elem,e);let r="checkbox"==t.target.type?t.target.checked:t.target.value;e.set(i,r,{target:t.target,src:"input"}),e.emit("input",t)}}function g(t){var e=f.call(this,t.key);e.length?v.call(this,e,t):this._log.options.lowestLvl<3&&self._log.last().addHandling(`Ignoring <${evt}> event for key '${key}'`)}function f(t){var e,r,n="debug";t:{let a=i.checkType(["nodelist","array","node","string","undefined"],t);switch(a){case"nodelist":t=Array.from(t);case"array":e=t.filter(t=>t.classList.contains(this._private.targetClass)),r="List of nodes passed in, returning only those connected to this binder:";break t;case"node":i.multiQuerySelector(t,this._private.targetClass,"self","class"),r="Single node passed in, finding all its children connected to this binder:";break t}if(!(e=Array.from(document.getElementsByClassName(this._private.targetClass))).length){if(this._log.options.lowestLvl<3){r="No nodes connected to binder";let t=this._log.last();if(t.msg!=r||t._age>1e3)break t}return[]}switch(n="trace",a){case"undefined":r="Nothing passed in, getting all nodes connected to this binder:";break t;case"string":r=`Getting nodes bound to key '${t}':`,e=e.filter(e=>{var i=u.call(this,e);return i.hasOwnProperty(t)||i.hasOwnProperty("*")});break t;default:this._log.throw("BUGBUG: util.checkType() returned unexpected value:",a)}}var a=[r,e,this],s=i.extractItems(e,(function(t,e,i){return t.hasAttribute("xxx-bind_ignore")}));return s.length&&a.splice(2,"Ignored flagged elems:",s),this._log[n].apply(this._log,a),e}function y(t){var e,r={};for(e of(i.checkType(["array","nodelist"],t),Array.from(t))){let t=u.call(this,e);Object.keys(t).forEach(t=>{r.hasOwnProperty(t)?r[t].push(e):r[t]=[e]})}return r}function v(t,e){var i,r,n;for(i of(this._log.traceFunc(arguments),t))try{if(!(n=u.call(this,i,e.key)).length)throw`No instructions for '${e.key}' or '*'`;for(r of n.values())r==i[a]&&i.hasAttribute("inputting")?this._log.note("Not outputting to currently receiving input.",r,e,i):this.executeAction(i,r,e)}catch(t){this._log.error("Failed to get instruction from node:",{node:i,instructions:n},t)}}return o.prototype=Object.create(t.Smarties.Object.prototype),Object.assign(o.prototype,e.prototype),Object.defineProperty(o.prototype,"constructor",{value:o}),Object.assign(o,e.static),Object.defineProperties(o,{_baseAttr:{value:"xxx-bind"},_instances:{value:t.BetterLog.BetterMap()},_defaultOptions:{value:{children:"complex",ignoreTimeout:3e3}},_staticOptions:{value:{inputDebounce:100}}}),o.upgradeSmarty=function(t,e,r){return r&&"SmartObject"==r.isSmart||i._log.makeTypeError("<SmartObject>",r).throw(),o.call(r,t,e,r),r},o._init=i.once((function(){o._instances.forEach(t=>{t._private.isSetup||t.setup()}),o._setupTwoWayBinding(),o._automaticallyBind()})),setTimeout((function(){o._setupTwoWayBinding._once||i._log.note("You have not run Binder._setupTwoWayBinding() which means binding is only one way, ie. any changes made by the user to DOM inputs won't affect the Binder (and will be overwritten if the Binder later changes"),o._automaticallyBind._once||i._log.note("You have not run Binder._automaticallyBind() which means current data won't be automatically propogated to new nodes, instead you have to call .triggerUpdate(node) manually, or wait for the data to change")}),3e3),o._parseElem=l,o._forgetElem=h,o._getBinder=c,o._getBindInstructions=u,o._findKeyBoundToValue=p,o._setupTwoWayBinding=i.once((function(){document.body.addEventListener("input",d,{passive:!0,capture:!1}),document.body.addEventListener("focusin",(function(t){l(t.target)})),i.markInputting(o._staticOptions.inputDebounce)})),o._automaticallyBind=i.once((function t(){const r=e.getLog();if(!document.body)return r.warn("Called too early, running again in 1s"),void setTimeout(t,1e3);const n=new MutationObserver((function(t){for(let a of t)if("attributes"==a.type){let t=a.target.className.split(" "),e=a.oldValue.split(" "),r=i.arrayDiff(t,e,"noCheck");if(r[0].length)for(let t of r[0])o._instances.has(t)&&o._instances.get(t).triggerUpdate(a.target);if(r[1].length)for(let t of r[1])o._instances.has(t)&&h(a.target)}else if(a.addedNodes.length){if(r.options.lowestLvl<3)var e=i.timerStart();let t=0;for(let e of a.addedNodes){var n=o._instances.keys();"element"==i.nodeType(e)&&Object.keys(i.multiQuerySelector(e,n,"group","self","class")).forEach(i=>{o._instances.get(i).triggerUpdate(e),t++})}r.options.lowestLvl<3&&r.debug(`It took ${i.timerStop(e,"nano")}ns to match ${t} Binders`)}}));Object.defineProperty(o._automaticallyBind,"observer",{value:n}),n.observe(document.body,{attributes:!0,attributeFilter:["class"],attributeOldValue:!0,childList:!0,subtree:!0})})),o.prototype.getOutputs=function(){return Array.from(document.getElementsByClassName(this._private.targetClass))},o.prototype.getInputs=function(){return this.getOutputs.filter(i.isInput())},o.prototype.setup=function(){return this._private.isSetup?this._log.warn("Setting up binder again..."):(this._log.debug("Setting up binder..."),this._private.isSetup=!0),this.parseAllElems(),this._private.scraped||i.isEmpty(this.scrape("return"))||this._log.warn("Possibly overwriting data already in the DOM. Did you forget to call .scrape() before .setup()? Remember, keys which only exist in the DOM will be set to their Binder-value which is 'undefined' (which in turn may set certain inputs to their default value)",{inDom:this._private.scraped,inBinder:this.copy()}),this.triggerUpdate(),this},o.prototype.parseAllElems=function(){return this.getOutputs().forEach(l.bind(this)),this},o.prototype.scrape=function(t="assign"){this._log.trace("Scraping DOM for values...");var e={},r=this;return this.getOutputs().forEach((function(t){let n=p.call(r,t);if(!n)return;let a=i.getValueFromElem(t);void 0!==a&&""!==a&&(e.hasOwnProperty(n)&&e[n]!=a&&this._log.warn(`Found different values for key '${n}' while scraping. Using the latter:`,e[n],a),e[n]=a)})),this._private.scraped=e,"return"==t?e:("assign"!=t&&this._log.warn("E_INVAL. scrape() is defaulting to action 'assign'. Passed in value is not valid:",t),this.assign(e),this)},o.prototype.triggerUpdate=function(t){this._log.traceFunc(arguments);try{var e=f.call(this,t);if(!e.length)return void this._log.warn("Trying to update of empty list of nodes, did this fire too soon? Search term:",t);var i=y.call(this,e);this._log.debug("Manually updating:",i),Object.entries(i).forEach(([t,e])=>{v.call(this,e,{key:t,value:this.get(t)})})}catch(e){this._log.error("Failed to update:",t,e)}},o.prototype.unbind=function(t){Array.from(t).forEach(t=>{t.classList.remove(this._private.targetClass),h(t)})},o}},function(t,e,i){"use strict";
/*
* @component Navigator
* @part-of xxx-framework
* @description Navigators show and hide elements using various means like url hash. It uses "logic states", ie. HIGH 
*              and LOW instead of 'show' and 'hide'. If the 'mode' set on an element is 'inverse', then HIGH=hide 
*              whereas normally HIGH=show. 
* @author plundell
* @license Apache-2.0
* @note: This component is required by ./xxx.proto.js, you should not need to access it directly.
* @depends libbetter
* @depends ./xxx.proto.js
* @exports {function} Call this function with the dependencies to get the Navigator constructor
*
*
* TODO 2020-01-09: Change 'key' to 'key' so we don't confuse with element key
* TODO 2020-02-07: Add '!' to mean 'when all are low', ie. the opposite of '*' => when all are high
*/t.exports=function(t,e){const i=t.BetterUtil;function r(t,i={},n=null){e.addInstance.call(this,t),e.setupPrivateLogEvents.call(this,t,i);var a=this._private.options;a.highligthClass=a.highligthClass||t+"_highlight",this._private.hashKey="string"==typeof a.hashRouter?a.hashRouter:t,this._private.targetClass=t,e.setupActions.call(this,["show","hide","classif"]),this.registerActionHandler("highlight",t=>this.executeAction(t.node,{fn:"classif",args:[a.highligthClass]},{value:t.value})),this.registerActionHandler("title",t=>r.setText.call(this,Object.assign(t,{value:this.getHighKeys().join(",")}))),n&&this.setup(n)}function n(t){return t.xxxNav||(t.xxxNav=e.getInstructions.call(this,t,e=>{if("link"==e.fn&&(e.fn="open",t.classList.add("xxx-nav_link")),"open"==e.fn||"close"==e.fn){var i,r="open"==e.fn?"high":"low";return"*"==e.key?i=this[r+"All"].bind(this):(e.args.includes("only")?r+="Only":r=r.toUpperCase(),i=this[r].bind(this,e.key)),t.onclick=()=>{try{t.classList.add("xxx-nav_used"),i()}catch(t){this._log.error("BUGBUG: onclick failed. ",t)}},t.setAttribute("xxx-nav_noaction",""),"drop"}},"group"),t.xxxNav.keys().forEach(t=>{this._private.states.hasOwnProperty(t)||(this._private.states[t]=!1,Object.defineProperty(this,t,{get:()=>this._private.states[t]}))})),t.xxxNav}function a(t,e){this._log.trace(t,e),this.emit("before",t,e);var i=Object.assign({},this._private.states);return i["*"]=this._private.states["*"],i}function s(t){var e,i=[];for(e in this._private.states)this._private.states[e]!=t[e]&&i.push(e);return this.emit("after",i),i}function o(t){var e="string"==i.checkType(["string","array"],t)?[t]:t;let r=e.indexOf("*");return r>-1&&e.splice(r,1),e}function l(t,e,i){try{let l=this._private.states[t]==e?["Ensuring","is","trace"]:["Setting","to","info"];this._log[l[2]](`${l[0]} key '${t}' ${l[1]} ${e?"HIGH":"LOW"}. Nodes:`,i);var r,n,a=[],s={key:t,value:e};for(r of i)try{var o=r.xxxNav[t];if(!o||!o.length)throw new Error("BUGBUG: Node doesn't have instructions but still got into propogateToNodes()");for(n of o)this.executeAction(r,n,s)}catch(t){this._log.error("Failed to propogate to node:",{node:r,instructions:o},t),a.push(i)}return a.length&&this.emit("failed",t,e,a),void(i.length&&a.length==i.length||(this._private.states[t]=e))}catch(t){this._log.error("BUGBUG:",t,arguments)}}return r.prototype=Object.create(t.BetterEvents.prototype),Object.assign(r.prototype,e.prototype),Object.defineProperty(r.prototype,"constructor",{value:r}),Object.assign(r,e.static),Object.defineProperties(r,{_baseAttr:{value:"xxx-nav"},_instances:{value:t.BetterLog.BetterMap()},_defaultOptions:{value:{showMultiple:!1,alwaysShowOne:!0,highligthClass:null,defaultHigh:null,hashRouter:!1}}}),r.prototype.getNodes=function(t){if(!this._private.states)throw this._log.makeError("Navigator not setup yet, cannot interact with it");var e=Array.prototype.slice.call(document.getElementsByClassName(this._private.targetClass));return e=e.filter(t=>n.call(this,t).length),"string"==typeof t?e.filter(e=>e.xxxNav.hasOwnProperty(t)):Array.isArray(t)?e.filter(e=>i.anyArrayOverlap(t,Object.keys(e.xxxNav))):e},r.prototype.getNodesGroupedByKey=function(){var t={};return this.getNodes().forEach(e=>{e.xxxNav.keys().forEach(r=>i.pushToNestedArray(t,r,e))}),t},r.prototype.getKeys=function(){return this.getNodes(),Object.keys(this._private.states)},r.getKeysByState=function(){var t=i.groupKeysByValue(this._private.states);return{high:t.true,low:t.false}},r.prototype.getHighKeys=function(){return Object.entries(this._private.states).filter(t=>t[1]).map(t=>t[0])},r.prototype.getLowKeys=function(){return this.getNodes(),Object.entries(this._private.states).filter(t=>!t[1]).map(t=>t[0])},r.prototype.setup=function(t){if(!this._private.states){this._log.info("Setting up navigator "+this._private.targetClass,this),"object"==i.checkType(["object","undefined"])?this._private.states=i.objCreateFill(Object.keys(t),!1):this._private.states={},Object.defineProperty(this._private.states,"*",{enumerable:!1,get:()=>Object.keys(this._private.states).some(t=>t),set:()=>{}});var e=this._private.options;return t?this.highOnly(i.groupKeysByValue(t).true):e.defaultHigh?this.highOnlyDefault():1==e.alwaysShowOne?(e.defaultHigh=this.getKeys()[0],this._log.warn("defaultHigh not set, but alwaysShowOne==true which forces us to use first key found as default: "+e.defaultHigh),this.highOnlyDefault()):this.lowAll(),e.hashRouter&&this.setupHashRouter(),this}this._log.warn("Already setup",this)},r.prototype.setupHashRouter=function(){if(this._private.followHash||this._private.setHash)this._log.note("Hash routing already running on this Navigator");else{this._log.info("Starting hash routing...");try{this._private.readAndFollowHash=()=>{var t=i.queryStrToObj(window.location.hash)[this._private.hashKey];t?(this._log.trace("Hash changed, following our part:",t),this.highOnly(t)):this._log.trace("Hash changed but doesn't reference our navigator:",window.location.hash)},this._private.readAndFollowHash(),window.addEventListener("hashchange",this._private.readAndFollowHash),this._private.setHash=this.on("after",t=>{if(t.length){var e=this.getHighKeys(!0);0==this._private.options.showMultiple&&(e=e[0]);var r=i.queryStrToObj(window.location.hash);e&&e.length?r[this._private.hashKey]=e:delete r[this._private.hashKey];var n=i.objToQueryStr(r);n=n?"#"+n:n,window.location.hash!=n&&(this._log.trace(`Updating uri hash: ${window.location.hash} => ${n}`),window.location.hash=n)}})}catch(t){this._log.error("BUGBUG",t),this.stopHashRouter()}}},r.prototype.stopHashRouter=function(){var t=!1;if(this._private.setHash){try{this.off(this._private.setHash),t=!0}catch(t){this._log.error("BUGBUG",t)}delete this._private.setHash}if(this._private.readAndFollowHash){try{window.removeEventListener("hashchange",this._private.readAndFollowHash),t=!0}catch(t){this._log.error("BUGBUG",t)}delete this._private.readAndFollowHash}t?this._log.debug("Stopped hash routing on this Navigator"):this._log.note("Hash routing isn't running on this Navigator, nothing to stop")},r.prototype.HIGH=function(t){if(0==this._private.options.showMultiple)return this.highOnly(t);var e=o(t),i=a.call(this,e),r=this.getNodesGroupedByKey();return e.forEach(t=>l.call(this,t,!0,r[t])),r.hasOwnProperty("*")&&!e.includes("*")&&l.call(this,"*",!0,r["*"]),s.call(this,i)},r.prototype.highOnly=function(t){var e=o(t);0==this._private.options.showMultiple&&e.length>1&&this._log.throw("Cannot set multiple keys to high (since option showMultiple==false). Got:",e);var i,r=a.call(this,"highOnly",e),n=this.getNodesGroupedByKey();for(i in n){if("*"==i)continue;let t=e.includes(i);l.call(this,i,t,n[i])}return n.hasOwnProperty("*")&&l.call(this,"*",!0,n["*"]),s.call(this,r)},r.prototype.highAll=function(){return this.HIGH(this.getKeys())},r.prototype.highOnlyDefault=function(){if(this._private.options.defaultHigh)return this.highOnly(this._private.options.defaultHigh);this._log.throw("No default elem set")},r.prototype.LOW=function(t,...e){var r=o(t),[n,h,c]=i.arrayDiff(this.getHighKeys(),r);if(this._private.options.alwaysShowOne&&!n.length){if(this._private.options.defaultHigh)return this.highOnly(this._private.options.defaultHigh);this._log.throw("Cannot LOW last element(s) with options alwaysShowOne==true && defaultHigh==null",c)}var u=a.call(this,e.includes("lowAll")?"lowAll":"LOW",r),p=this.getNodesGroupedByKey();return r.forEach(t=>l.call(this,t,!1,p[t])),n.length||!p.hasOwnProperty("*")||e.includes("ignoreStar")||l.call(this,"*",!1,p["*"]),s.call(this,u)},r.prototype.lowAll=function(){1==this._private.options.alwaysShowOne&&this._log.throw("LOWing all not permitted on this navigator, see option alwaysShowOne==true");let t=this.getKeys();return this.LOW(t)},i.createCSSRule(".xxx-nav_link","text-decoration: underline; color:blue;"),i.createCSSRule(".xxx-nav_link.xxx-nav_used","color:purple"),i.createCSSRule(".xxx-nav_link:hover","cursor:pointer;"),r}},function(t,e,i){"use strict";
/*
* @component Repeater
* @part-of xxx-framework
* @author plundell
* @license Apache-2.0
* @description Repeaters use standalone/underlying smarties.Array to repeat templates within a target element 
*              in the DOM. 
* @note: This component is required by ./xxx.proto.js, you should not need to access it directly.
* @depends libbetter
* @depends ./xxx.binder.js
* @depends ./xxx.proto.js
* @depends smarties.Array
* @exports {function} Call this function with the dependencies to get the Repeater constructor
*
* ProTip: If each clone is to contain mutiple pieces of data, then the value of the
*		  smarties.Array should be used to set classes/data-bind attributes on children of
*		  the clone for a seperate Binder to use
*
* DEPRECATED: If you see empty arrays / instructions it was the old way of preventing Repeater
*			  from warning when you intentionally wanted no actions. The new way is to use
* 				'{"x":"noaction"}'
*
* Terminology:
*  "Pattern":
*		Repeaters use pattern instead of regular keys in order for format the value passed to
*		action functions. The pattern can also make use of the index. Examples:
*			index=1, value='red', pattern='#' 			=> 	1
*			index=2, value='blue', pattern='$'			=>	'blue'	
*			index=3, value='green', pattern='#-$'		=>	'3-green'
*			index=4, value={foo:'bar'}, pattern='$'		=>	{foo:'bar'} 		*live object
*			index=4, value={foo:'bar'}, pattern='foo'	=>	'foo' 				*probably not what you want
*			index=4, value={foo:'bar'}, pattern='${foo}'=>	'bar'
*			index=4, value={foo:'bar'}, pattern='#$'	=>	"4{'foo':'bar'}"	*probably not what you want
*			index=6, value={foo:'bar',me:{age:30}}, pattern='#-${me.age}${foo}#hat'
*														=>	"6-15bar6hat"  
*/t.exports=function(t,e){e.Binder;const i=t.BetterUtil,r=document.implementation.createHTMLDocument("blackhole"),n="repeat-index-dependent";function a(t,i={},r=null){try{e.addInstance.call(this,t),e.setupPrivateLogEvents.call(this,t,i),this._private.dataEventCallback=c.bind(this);var n=!1;Object.defineProperty(this._private,"indexDependentPatterns",{enumerable:!0,get:()=>n,set:t=>{n?n!=t&&(n="both"):(t&&this._private.options.debugMode&&this._log.warn("Possible slowdown! By using patterns with '#', every time you alter the order of items (ie. by adding/deleting/moving items in the middle) a 'change' event will fire."),n=t)}}),e.setupActions.call(this),r&&(this._log.debug("Setting up data right away..."),this.setupData(r))}catch(t){console.error(typeof t,t.constructor.name,t),e.getLog(this).throw("Failed to setup Repeater.",t,arguments)}}function s(){if(this._target.childElementCount&&this._log.throw("Target is not empty, cannot add items since it may create duplicates",this._target),this._data.length){this._log.debug(`Going to add all ${this._data.length} items to target:`,this._target);var t=this._data._private.data.map((t,e)=>o.call(this,{value:t,key:e,src:"addAll"}));return this._log.trace("All items added",t),t}}function o(t){try{var e=y.call(this,t.key,t.value),i=p.call(this,e);let r=this._log.makeEntry("debug","Prepared new repeat item:").addHandling("Children with instructions:",i);v.call(this,e,t),r.addHandling("Data:",t).exec()}catch(i){e=document.createElement("span");this._log.error("Failed to get template. Substituting empty <span> to keep Repeater in-sync with underlying data",i,e,t),e._checkRightTemplate=function(){return!1}}if(t.key==this.length?this._target.appendChild(e):this._target.insertBefore(e,this._target.children[t.key]),this._private.options.addGetters){let t=this._target.childElementCount-1,e=this;Object.defineProperty(this,t,{enumerable:!0,configurable:!0,get:function(){return e._target.children[t]}})}return e}function l(t){var e=this.findNestedRepeaters(t,!0);return e.length?(this._log.debug(`Destroying ${e.length} nested repeaters before proceeding:`,e),e.forEach(t=>t._repeater.destroy()),this._log.debug("Done destroying children, now removing this elem:",t)):this._log.debug("No nested repeaters found, just removing this elem:",t),r.adoptNode(t),t}function h(){var t,e,i=this._target.childElementCount;for(this._log.debug(`Emptying target of all ${i} elements:`,this._target),this.length<i&&this._log.warn("Additional elements in target detected, these will be removed as well");this._target.childElementCount;)l.call(this,this._target.lastElementChild);if(this._private.options.addGetters)for(t of Object.getOwnPropertyNames(this))try{1==(e=Object.getOwnPropertyDescriptor(this,t)).enumerable&&"function"==typeof e.get&&delete this[t]}catch(i){this._log.error("Problems while deleting public getters. Current prop: "+t,i,e)}}function c(t){try{if(this._log.traceFunc(arguments),isNaN(Number(t.key)))return void this._log.error("BUGBUG: Repeaters can't handle nested keys, we're only interested in what happens with the local array");var e,r;if("new"==t.evt){e=o.call(this,t);let i=this.length-1;this._private.indexDependentPatterns&&t.key<i&&(r=cX.range(t.key+1,i))}else{if(e=this._target.children[t.key],"node"!=i.varType(e))return void this._log.error("Child #"+t.key+" does not exist, cannot propogate event: "+evt);switch(evt){case"indexChange":"i"==this._private.indexDependentPatterns||e._checkRightTemplate(value)?"t"!=this._private.indexDependentPatterns&&e.hasAttribute(n)?v.call(this,e,t,"onlyIndexPatterns"):this._log.trace("Ignoring elem without index dependent pattern.",t,e):(l.call(this,e),e=o.call(this,t),this._log.debug("Changed templates for elem #"+t.key,e));break;case"change":e._checkRightTemplate(value)?v.call(this,e,t):(l.call(this,e),e=o.call(this,t),this._log.debug("Changed templates for elem #"+t.key,e));break;case"delete":this._log.debug("Removing repeater elem #"+t.key,e);let i=this.length-1;this._private.indexDependentPatterns&&t.key<i&&(r=cX.range(t.key,i)),l.call(this,e),this._private.options.addGetters&&delete this[this.length];break;case"move":this._log.debug("Moving repeater elem #"+t.from+" to #"+t.to,e),this._private.indexDependentPatterns&&(r=[Math.min(t.from,t.to),Math.max(t.from,t.to)]),this._target.insertBefore(e,this._target.children[t.to]);break;default:this._log.note("Unhandled event: "+evt)}}r&&r.forEach(e=>c.call(this,Object.assign({},t,{evt:"indexChange",key:e,old:t.value}))),t.target=e,this.emit(t)}catch(t){this._log.error("BUGBUG",t)}}function u(){this._log.traceFunc(arguments);try{var t,e;if(this._private.options.target){if(!(t=i.getLiveElement(this._private.options.target,!0)))throw this._log.makeError("Bad target (arg#2)",this._private.options.target);this._log.debug("Using explicit target:",this._private.options.target)}else try{t=(e=i.getLiveElement(this._private.options.template,!1)).parentNode,this._log.debug("Using templates' parent as target:",t)}catch(t){throw this._log.debug("No explicit target specified, trying templates' parent"),t}t.ownerDocument!=document&&this._log.throw("The target is not part of this document:",t);let r=t.childElementCount;return r>0&&((r>1||t.firstElementChild!=e)&&this._log.throw("Repeater targets must be empty.",{target:t,liveTemplate:e,template:this._private.options.template,Repeater:this}),t.removeChild(e)),t.setAttribute("repeater-target",this._private.targetClass),t._repeater=this,t}catch(t){this._log.throw("Failed to get target.",t)}}function p(t){document.adoptNode(t),t.setAttribute("repeater-item",this._private.targetClass),Object.defineProperties(t,{_repeater:{enumerable:!0,get:()=>this},_repeatIndex:{enumerable:!0,get:()=>Array.from(t.parentElement.children).indexOf(t)},_repeatData:{enumerable:!0,get:()=>this._data.get(t._repeatIndex)}});let e=this.getNodesWithInstructions(t);return e.forEach(d.bind(this)),e}function d(t){if(!t.hasOwnProperty("xxxRepeat")){if(t.hasAttribute("xxxRepeat"))t.xxxRepeat=i.getJsonAttr(node,"xxxRepeat"),this._private.options.debugMode||node.removeAttribute("xxxRepeat");else{let i=e.getInstructions.call(this,t,g.bind(this),this._private.options.debugMode?"extract":"","emptyOK");t.xxxRepeat=i.length?i:null}t.xxxRepeat&&t.classList.add(this._private.targetClass)}return t.xxxRepeat}function g(t){switch(t.pattern=t.key,delete t.key,typeof t.pattern){case"string":t.pattern.includes("#")?(this._private.indexDependentPatterns="i",this._log.warn("Slow instruction:",t)):t.pattern.includes("$")||(t.pattern="${"+t.pattern+"}");break;case"object":t.pattern="${"+t.pattern.join(".")+"}";break;case"number":this._log.makeError("Repeater key/pattern cannot be numbers:",t.pattern).throw("TypeError")}"primitive"==this._data._private.options.children&&t.pattern.match(/\$\{([^}]+)\}/)&&this._log.makeError(`options.children=='primitive' => no complex patterns: '${t.pattern}'`).throw("EMISSMATCH")}function f(t,e,r,n){try{var s=r[0],o=a.applyPattern.call(this,t,e,s,n),l=r[1],h=r[2];return i.compare.call(this,o,l,h)}catch(t){return this._log.error(t),!1}}function y(t,e){if(this._templates.length>1){for(var r,n=[],a=0;a<this._templates.length;a++){var s=this._templates[a];if(s.hasAttribute("xxx-repeat_usedefault"))r=s;else{var o=i.getJsonAttr(s,"xxx-repeat_useif");if(n.push(o),f.call(this,t,e,o,s)){var l=s.cloneNode(!0);return this._log.debug("Rule matched, cloned template:",checkedRule,l),l._checkRightTemplate=t=>f.call(this,l._repeatIndex,t,o,l),l}}}r||this._log.throw("None of the templates matched this value (and there's no default):",e,n);l=r.cloneNode(!0);return this._log.debug("No rule matched, using default:",l,{value:e,rules:n}),l._checkRightTemplate=t=>{let e=l._repeatIndex;for(var i=0;i<n.length;i++)if(f.call(this,e,t,n[i],l))return!1;return!0},l}l=this._templates[0].cloneNode(!0);return this._log.debug("Only one template existed, cloned that:",l),l._checkRightTemplate=function(){return!0},l}function v(t,e,i=!1){if(e&&"object"==typeof e&&e.hasOwnProperty("value")){this._log.traceFunc(arguments);var r,n,a=this.getNodesWithInstructions(t);for(r of a)if(Array.isArray(r.xxxRepeat)&&r.xxxRepeat.length)for(n of r.xxxRepeat)i&&!e.pattern.includes("#")||this.executeAction(r,n,e);else this._log.error("BUGBUG No instructions on node:",r)}else this._log.makeError("Bad data. Could not propogate to repeater item.",{item:t,data:e}).addFrom().exec()}return a.prototype=Object.create(t.BetterEvents.prototype),Object.assign(a.prototype,e.prototype),Object.defineProperty(a.prototype,"constructor",{value:a}),Object.assign(a,e.static),Object.defineProperties(a,{_baseAttr:{value:"xxx-repeat"},_instances:{value:t.BetterLog.BetterMap()},_defaultOptions:{value:{children:"complex",moveEvent:!0,addGetters:!0,target:null,template:'<span xxx-repeat=\'[{"value":"#"}]\'></span>',debugMode:!0}}}),Object.defineProperty(a.prototype,"length",{get:function(){return"node"==i.varType(this._target)?this._target.childElementCount:0}}),a.prototype.isSetup=function(){return!("object"!=typeof this._data||!this._data.hasListener("event",this._private.dataEventCallback))&&("node"==i.varType(this._target)&&this._target.ownerDocument==document||(this._log.warn("Target no longer valid",this._target,this),!1))},a.prototype.setupData=function(e){if(this.hasOwnProperty("_data")){if(null==e)return this._data;this._log.throw("Data already setup on this repeater")}var r;switch(i.varType(e)){case"undefined":case"array":r=new t.Smarties.Array(this._private.options),e?(r.concat(e),this._log.debug("Creating smartArray on repeater with data:",r)):this._log.note("Creating empty smartArray on repeater. Don't forget to populate it later!");break;case"object":if("SmartArray"==e.isSmart){this._log.debug("Using passed in smartArray on repeater:",e),r=e;break}default:this._log.throwType("array or smarties.Array",e)}return Object.defineProperty(this,"_data",{value:r}),this._log.extend(r._log),this},a.prototype.get=function(t){return this._private._data?this._private._data.get(t):void 0},a.prototype.set=function(t,e){return this._private._data?this._private._data.set(t,e):void 0},a.prototype.getNodesWithInstructions=function(t){t=t||this._target,cX.checkType("node",t);var e=Array.from(t.getElementsByClassName(this._private.targetClass));return t&&t.classList.contains(this._private.targetClass)&&e.push(t),e},a.prototype.repopulateTarget=function(){return h.call(this),s.call(this),this},a.prototype.setup=function(t){if(this.isSetup())Array.isArray(t)?(this._log.trace("Setting up with new data, old/new:",this._data.get(),t),this.replace(t)):this._log.warn("Repeater already setup, cannot do it again",this);else{this._private.options;if(this.setupData(t),this._templates||Object.defineProperty(this,"_templates",{value:this.prepareTemplates()}),!this._target||this._target.ownerDocument!=document){let t=u.call(this);Object.defineProperty(this,"_target",{configurable:!0,value:t})}s.call(this),this._log.trace("Repeater should now be setup/visible"),this._data.on("event",this._private.dataEventCallback)}return this},a.prototype.destroy=function(t=!1){return t||this.isSetup()?(this._log.debug("Going to stop listening to private data and empty target of elements.",this),this._data.removeListener(this._private.dataEventCallback,"event"),h.call(this)):this._log.warn("Repeater not setup, nothing to destroy",this),this},a.prototype.findNestedRepeaters=function(t,e=!1){i.checkType("node",t);var r=Array.from(t.querySelectorAll("[repeater-target]"));if(r.length){var n={};r.forEach(t=>{if(e&&!t._repeater.isSetup())return;0;let r=i.countParentNodes(t);n.hasOwnProperty(r)?n[r].push(t):n[r]=Array(t)}),r=[];Object.keys(n).sort().reverse().forEach(t=>{r.push.apply(r,n[t])})}return r},a.prototype.countNestedItems=function(t=!1){for(var e=this.length,i=0,r=0;r<e;r++)this.findNestedRepeaters(this[r],t).forEach(t=>i+=t.length);return i},a.prototype.replace=function(t){this.hasOwnProperty("_data")||this._log.throw("Not data setup yet, cannot replace");try{var e=this._data.get();this._data.replace(t,"panic")}catch(e){this._log.warn("Regular delete->event->propogate failed. Manually emptying DOM target and data.",e),h.call(this),this._data._brutalEmpty(),this._data.concat(t)}return e},a.prototype.empty=function(){return this.replace([])},a.prototype.prepareTemplates=function(){var t,e=i.getLiveElement(this._private.options.template);if((t="TEMPLATE"==e.tagName?Array.from(e.content.children,t=>document.importNode(t,!0)):[document.importNode(e,!0)]).length>1)for(var r=t.length-1;r>-1;r--){let e=t[r];if(!e.hasAttribute("xxx-repeat_usedefault")){let n="xxx-repeat_useif";if(!e.hasAttribute(n)){this._log.warn("Removing one of multiple templates because it's missing useif/usedefault attributes:",e),t.splice(r,1);continue}var s=e.getAttribute(n);1==(s=i.tryJsonParse(s,!0)||[s]).length?s.unshift("$","=="):e.getAttribute(s[0]).includes("#")&&(this._private.indexDependentPatterns="t",this._log.warn("Slow template chooser:",s)),e.setAttribute(n,JSON.stringify(s))}}return t.length>1?this._log.info(`Multiple templates (${t.length}) found:`,t):this._log.debug("Single template found:",t[0]),t.forEach((e,i)=>{var r=Array.from(e.getElementsByTagName("*"));r.push(e);var s=0;r.forEach(t=>{try{t.hasAttribute("id")&&(t.setAttribute("_id",t.getAttribute("id")),t.removeAttribute("id"));var i=d.call(this,t);i&&(t.setAttribute("xxxRepeat",JSON.stringify(i)),s+=i.length,!e.hasAttribute(n)&&i.find(t=>t.pattern.includes("#"))&&e.setAttribute(n,""))}catch(e){this._log.error("Failed to prepare template node.",e,t)}});let o=`Prepared template ${i+1} of ${t.length},`,l=a._baseAttr+"_noaction";s||e.hasAttribute(l)?this._log.debug(`${o} it has ${s} instructions`):this._log.warn(`${o} but it has no instructions! (if intentional please add attribute '${l}'`)}),t},a}}]);